<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Daily Weather Predictor</title>
    <!-- Load Tailwind CSS from CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple loading spinner */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Import Inter font from Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;700&display=swap" rel="stylesheet">
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">

    <div class="bg-white rounded-lg shadow-xl max-w-2xl w-full overflow-hidden">
        
        <!-- Top Part: Weather Display -->
        <div class="p-8 md:p-12 bg-gradient-to-r from-blue-500 to-indigo-600 text-white">
            <h1 class="text-3xl font-bold mb-4">Today's Weather Outlook</h1>
            <div id="weather-display" class="bg-white bg-opacity-20 rounded-lg p-6 min-h-[100px] flex items-center justify-center">
                <!-- Weather content will be loaded here -->
                <div id="weather-loading" class="flex flex-col items-center">
                    <div class="loader"></div>
                    <p class="mt-2 text-sm font-medium">Fetching today's prediction...</p>
                </div>
                <div id="weather-content" class="hidden text-center">
                    <p id="weather-icon" class="text-6xl mb-2"></p>
                    <p id="weather-message" class="text-xl font-medium"></p>
                </div>
                <p id="weather-error" class="hidden text-red-100 font-medium"></p>
            </div>
        </div>

        <!-- Bottom Part: Email Subscription -->
        <div class="p-8 md:p-12">
            <h2 class="text-2xl font-semibold text-gray-800 mb-3">Subscribe for Daily Updates</h2>
            <p class="text-gray-600 mb-6">Get the daily weather prediction sent straight to your inbox every morning.</p>
            
            <!-- Subscription Form -->
            <form id="subscribe-form" class="flex flex-col sm:flex-row gap-3">
                <label for="email" class="sr-only">Email address</label>
                <input 
                    type="email" 
                    id="email" 
                    placeholder="you@example.com" 
                    required 
                    class="flex-grow w-full px-4 py-3 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200"
                >
                <button 
                    type="submit" 
                    id="subscribe-button"
                    class="bg-blue-600 text-white font-semibold px-6 py-3 rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition duration-200"
                >
                    Subscribe
                </button>
            </form>
            
            <!-- Message area for success/error -->
            <div id="form-message" class="mt-4 text-sm font-medium"></div>
        </div>
    </div>

    <script>
        // Define the backend API base URL
        // Make sure your Node.js server is running on this port
        const API_URL = 'http://localhost:3000';

        // --- Weather Code Interpretation ---
        
        /**
         * Translates a WMO weather code into a human-readable message and an emoji icon.
         * @param {number} code - The WMO weather code.
         * @returns {{message: string, icon: string}} - An object with the message and icon.
         */
        function interpretWeatherCode(code) {
            switch (code) {
                case 0: return { message: 'Clear sky', icon: 'â˜€ï¸' };
                case 1: return { message: 'Mainly clear', icon: 'ðŸŒ¤ï¸' };
                case 2: return { message: 'Partly cloudy', icon: 'â›…' };
                case 3: return { message: 'Overcast', icon: 'â˜ï¸' };
                case 45: return { message: 'Fog', icon: 'ðŸŒ«ï¸' };
                case 48: return { message: 'Depositing rime fog', icon: 'ðŸŒ«ï¸' };
                case 51: return { message: 'Light drizzle', icon: 'ðŸŒ¦ï¸' };
                case 53: return { message: 'Moderate drizzle', icon: 'ðŸŒ¦ï¸' };
                case 55: return { message: 'Dense drizzle', icon: 'ðŸŒ§ï¸' };
                case 56: return { message: 'Light freezing drizzle', icon: 'ðŸŒ¨ï¸' };
                case 57: return { message: 'Dense freezing drizzle', icon: 'ðŸŒ¨ï¸' };
                case 61: return { message: 'Slight rain', icon: 'ðŸŒ¦ï¸' };
                case 63: return { message: 'Moderate rain', icon: 'ðŸŒ§ï¸' };
                case 65: return { message: 'Heavy rain', icon: 'ðŸŒ§ï¸' };
                case 66: return { message: 'Light freezing rain', icon: 'ðŸŒ¨ï¸' };
                case 67: return { message: 'Heavy freezing rain', icon: 'ðŸŒ¨ï¸' };
                case 71: return { message: 'Slight snow fall', icon: 'ðŸŒ¨ï¸' };
                case 73: return { message: 'Moderate snow fall', icon: 'â„ï¸' };
                case 75: return { message: 'Heavy snow fall', icon: 'â„ï¸' };
                case 77: return { message: 'Snow grains', icon: 'â„ï¸' };
                case 80: return { message: 'Slight rain showers', icon: 'ðŸŒ§ï¸' };
                case 81: return { message: 'Moderate rain showers', icon: 'ðŸŒ§ï¸' };
                case 82: return { message: 'Violent rain showers', icon: 'â›ˆï¸' };
                case 85: return { message: 'Slight snow showers', icon: 'ðŸŒ¨ï¸' };
                case 86: return { message: 'Heavy snow showers', icon: 'â„ï¸' };
                case 95: return { message: 'Thunderstorm', icon: 'â›ˆï¸' };
                case 96: return { message: 'Thunderstorm with slight hail', icon: 'â›ˆï¸' };
                case 99: return { message: 'Thunderstorm with heavy hail', icon: 'â›ˆï¸' };
                default: return { message: `Unknown weather code: ${code}`, icon: 'â“' };
            }
        }

        // --- DOM Elements ---
        const weatherLoading = document.getElementById('weather-loading');
        const weatherContent = document.getElementById('weather-content');
        const weatherError = document.getElementById('weather-error');
        const weatherIcon = document.getElementById('weather-icon');
        const weatherMessage = document.getElementById('weather-message');
        const subscribeForm = document.getElementById('subscribe-form');
        const emailInput = document.getElementById('email');
        const subscribeButton = document.getElementById('subscribe-button');
        const formMessage = document.getElementById('form-message');

        // --- Fetch Weather on Page Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                const response = await fetch(`${API_URL}/weather`);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }
                
                // Assuming the backend sends JSON like: {"weatherCode": 3}
                const data = await response.json();
                const weatherCode = data.weatherCode;

                if (weatherCode === undefined) {
                     throw new Error('Invalid data format from server.');
                }

                const { message, icon } = interpretWeatherCode(parseInt(weatherCode, 10));

                // Display weather
                weatherIcon.textContent = icon;
                weatherMessage.textContent = message;
                weatherLoading.classList.add('hidden');
                weatherContent.classList.remove('hidden');

            } catch (error) {
                console.error('Failed to fetch weather:', error);
                weatherError.textContent = 'Could not load weather. Please try again later.';
                weatherLoading.classList.add('hidden');
                weatherError.classList.remove('hidden');
            }
        });

        // --- Handle Subscription Form ---
        subscribeForm.addEventListener('submit', async (e) => {
            e.preventDefault(); // Prevent default form submission
            
            const email = emailInput.value;
            if (!email) return;

            // Disable form and show loading state
            subscribeButton.disabled = true;
            subscribeButton.textContent = 'Subscribing...';
            formMessage.textContent = '';
            formMessage.className = 'mt-4 text-sm font-medium';

            try {
                const response = await fetch(`${API_URL}/subscribe`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email }),
                });

                const result = await response.json();

                if (!response.ok) {
                    throw new Error(result.message || 'Subscription failed.');
                }

                // Success
                formMessage.textContent = result.message || 'Success! You are now subscribed.';
                formMessage.classList.add('text-green-600');
                emailInput.value = ''; // Clear input field

            } catch (error) {
                console.error('Subscription error:', error);
                formMessage.textContent = error.message || 'An error occurred. Please try again.';
                formMessage.classList.add('text-red-600');
            } finally {
                // Re-enable form
                subscribeButton.disabled = false;
                subscribeButton.textContent = 'Subscribe';
            }
        });
    </script>
</body>
</html>
